---
title: "Introduction to package 'precautionary'"
author: "David C. Norris"
date: "7/8/2020"
output: bookdown::tufte_html2
vignette: <
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Introduction to package 'precautionary'}
  \usepackage[utf8]{inputenc}
bibliography: precautionary-package.bib
---

```{r setup, include=FALSE}
options(rmarkdown.html_vignette.check_title = FALSE) # suppress un-needed warning
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.height = 4, fig.width = 6)

library(precautionary)
library(knitr)
library(kableExtra)
```

## Background

In package [escalation](https://CRAN.R-project.org/package=escalation), you can simulate a 3 + 3 design as follows:

```{r results='hide'}
library(escalation)
# Design a 3 + 3 trial, with 5 pre-specified doses to escalate through
design <- get_three_plus_three(num_doses = 5)
# Posit a scenario where these 5 doses cause dose-limiting toxicities
# (DLTs) in 12%, 27%, etc. of the population:
scenario <- c(0.12, 0.27, 0.44, 0.53, 0.57)
design %>% simulate_trials( # Feed the design to the simulator ...
  num_sims = 100            # run 100 simulated trials
, true_prob_tox = scenario  # under the chosen scenario,
) -> sims                   # and store the results.

summary(sims) # summarize simulation results
```

```{r basic-sim, echo=FALSE}
kable(summary(sims)
     ,caption="Simulation summary as produced by package `escalation`.")
```

From Table \@ref(tab:basic-sim), we learn a few things of interest. For example, we see that, with the lowest dose being too toxic for 12% of the population, under this scenario there is a real chance even this dose will be rejected by our trial. Conversely, we also find it is not impossible for our trial to recommend a dose that is toxic to nearly half the population. Note also that, by summing the $n$ column, we can estimate expected enrollment at `r sum(round(summary(sims)$n, digits=2))`, which perhaps informs us about the expected cost or duration of our trial.^[Any complete simulation study will of course consider multiple scenarios, perhaps weighted according to their varying likelihood.]

But simulations such as these cannot answer crucial questions about **trial safety**, mainly because the simulation machinery recognizes no notion of *graded toxicity*. The binary (yes/no) toxicities in the simulation machinery of `escalation` regard Grade 5 (fatal) toxicities no differently from Grade 3. 

## Introducing realistic pharmacologic thinking

The `precautionary` package solves this problem by pursuing a *realistic* approach to pharmacologic thinking. Rather than plucking a sequence of toxicity probabilities out of thin air, this approach **derives** such probabilities according to how a latent toxicity threshold is distributed in the population.

```{r}
library(precautionary)
mtdi_dist <- mtdi_lognormal(CV = 2          # coefficient of variation
                           ,median = 5      # median DLT threshold
                           ,units = "mg/kg" # real doses have units!
                           )
```

Likewise, the pre-specified doses for our dose-escalation design must be specified as actual doses. With package `precautionary`, this is accomplished by setting a `dose_levels` option:

```{r}
options(dose_levels = c(0.5, 1, 2, 4, 6)) # specify actual dosing
```

A plot of the MTD$_i$ distribution makes clear the connection with toxicity probabilities:

```{r}
plot(mtdi_dist)
```

```{r}
probs <- mtdi_dist@dist$cdf(getOption('dose_levels'))
names(probs) <- paste(getOption('dose_levels'), mtdi_dist@units)
t(probs) %>% kable(digits = 4)
```

## Extending `escalation` to support this

Package `precautionary` provides additional methods for `escalation` functions, so that an `mtdi_distribution` may be used instead of out-of-thin-air probabilities:

```{r, results='hide'}
design %>% simulate_trials(
  num_sims = 100
, true_prob_tox = mtdi_dist # pull tox probs from a MODEL, not thin air
) -> SIMS

summary(SIMS)
```
```{r MTDi-regime, echo=FALSE}
kable(summary(SIMS)
     ,caption = "A simulation summary under the MTD$_i$ regime of package `precautionary`.")
```

Judging from Table \@ref(tab:MTDi-regime), however, introducing the MTD$_i$ concept has by itself generated little progress. The only apparent improvement compared with Table \@ref(tab:basic-sim) is the addition of a column with *actual* doses. To make further progress *while continuing to operate within the dose-escalation paradigm*, we need to introduce another concept.

## Introducing graded toxicities

When its full implications are allowed to develop, the latent toxicity threshold MTD$_i$ has far-reaching consequences for the design of dose-finding trials. Indeed, it forms the conceptual basis for dose-*titration* designs that abandon cohortwise dose-escalation altogether [@norris_dose_2017; @norris_precautionary_2017].

For present purposes, however, we take it for granted that (for whatever reason) we have chosen to employ a dose-escalation design. That choice effectively discards the core insight of MTD$_i$, and relegates the MTD$_i$ concept *standing alone* to the status of a mere formalism. But in conjunction with *a dose scaling that links different toxicity grades at the individual level*, the MTD$_i$ can be rehabilitated as an effective tool, even within the confines of a dose-escalation design. In package `precautionary`, such scaling functions are called 'ordinalizers', and may be applied at the time when simulations are summarized:

```{r}
dose_tox_scaling <- function(MTDi, r0) {
  MTDi * r0 ^ c(Gr1=-2, Gr2=-1, Gr3=0, Gr4=1, Gr5=2)
}
summary(SIMS
       ,ordinalizer = dose_tox_scaling
       ,r0 = 2      # supply a value for ordinalizer's r0 parameter
       )$safety %>% # select the 'safety' component of the summary
  kable() %>% add_header_above(c(" "=1, "By toxicity grade"=6, " "=1))
```

Clearly, we have now made some genuine progress. Of special interest from a safety perspective are the numbers of Grade 4 (severe) and Grade 5 (fatal) toxicities expected in the trial.

## A closer look at the *ordinalizer*

Let us unroll the ordinalizer above, to make it less cryptic:

```{r, eval=FALSE}
dose_tox_scaling <-
  function(MTDi   # An ordinalizer is a function of a dose threshold,
          ,r0 = 2 # and in general has additional parameters as well.
          ) {
    # An ordinalizer assumes we start with a binary toxicity notion,
    # and maps that to a *graded* notion of toxicity by means of a
    # transformation in 'dose-space'.
    # Assuming the default value r0 = 2 provided in its definition,
    # this ordinalizer says that an individual whose dose threshold
    # for the binary toxicity is MTDi has thresholds ...
    c(Gr1 = MTDi / r0^2 # at MTDi/4 for Gr1,
     ,Gr2 = MTDi / r0   # at MTDi/2 for Gr2,
     ,Gr3 = MTDi        # at MTDi for Gr3 ('tox' is defined as Gr3+),
     ,Gr4 = MTDi * r0   # at 2*MTDi for Gr4,
     ,Gr5 = MTDi * r0^2 # at 4*MTDi for Gr5.
    )
  }
```

In general, an ordinalizer returns a named vector^[The names allow for user-customized labeling of the toxicity levels, which carries forward into summaries, etc.] that links the different doses at which an individual will experience each grade of toxicity. In [@norris_retrospective_2020], these concepts are laid out in terms of MTD$_i^g$ with the index $g$ running over toxicity grades:

$$
\mathrm{MTD}_i^g, g \in \{1,...,5\},
$$

and defined as the dose threshold where a grade-$(g-1)$ toxicity would convert to grade-$g$.^[To preserve the intuition of the term 'maximum tolerated dose', you could say MTD$_i^g$ is the maximum dose that individual $i$ can tolerate if 'tolerability' is defined as toxicity below grade-$g$.] Thus, in the usual case where the binary 'dose-limiting toxicity' (DLT) of a dose-escalation design is defined as CTCAE Grade 3 and above, we identify MTD$_i$ with MTD$_i^3$ .



TODO: Show how you can't use an ordinalizer directly on simulations from package 'escalation'. Explain that the `u_i` variable is missing, but has been supplied by an overridden function in 'precautionary'.

TODO: Show how you can set an `options(ordinalizer = <function>)`, and give advice that parameters (like `r0` above) in such a default ordinalizer generally warrant default settings, in order to fully yield the convenience-value of an option setting.

The ordinalizer given above adopts the basic assumption that the ordinal toxicities are equally spaced in logarithmic dose-space. For example, if $r_0 = 2$, then ...

### Fit a hyper_mtdi_distribution to a CRM skeleton

One way to understand the `hyper_mtdi_distribution` class is as a putative generator for the 'skeleton' of a CRM model.

#### Obtain dose-wise DLT probabilities from an MTDi distribution:

Use a lognormally-distributed MTD$_i$ inspired by [@norris_retrospective_2020]:

```{r derive-DLT-probs, eval=FALSE}
mu <- 5              # Values estimated in arXiv:2004.12755 [stat, q-bio];
sigma <- 1/sqrt(1.3) # see subsection 'Model estimates' and Table 2, pp. 2-3.
dose_levels <- c(2, 6, 20, 60, 180, 400)
MTDi <- Lognormal$new(meanlog = mu, sdlog = sigma)
DLT_probs <- MTDi$cdf(dose_levels)
```

#### Run a simple simulation

```{r simple-sim, eval=FALSE}
suppressWarnings( # "Unknown or uninitialised column: `u_i`" warnings (from Tibble?)
sims <- get_three_plus_three(num_doses = 6) %>%
  simulate_trials(num_sims = 200, true_prob_tox = DLT_probs)
)
```

#### Obtain ordinal toxicity outcomes via `u_i`


#### Try accelerated titration Ã  la NCT02848911

## References
